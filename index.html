<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Base64 Online Encoder Decoder | Base64 Encryption Decryption - Base64s.com</title>
    <link rel="icon" href="/static/images/logo.svg" type="image/png">
    <meta name="keywords" content="Base64,Base64 Encode,Base64 Decode,Base64 Encrypt,Base64 Decrypt">
    <meta name="description" content="Free online Base64 encoder and decoder with advanced security features. Convert text, images, files to Base64 instantly. Auto-detection, multiple encoding, privacy-focused.">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- 导航栏样式 -->
    <link rel="stylesheet" href="/static/css/navbar.css">
</head>

<body>
    <!-- 导航栏容器 - 将由JavaScript动态加载 -->
    <div id="navbar-container"></div>

    <!-- 内容区 -->
    <div class="container text-center" style="margin-top: 20px;margin-bottom: 20px;">
        <div class="row textarea-container">
            <div class="col input-section">
                <p class="fw-lighter text-start" data-main="inputLabel">Please enter the characters to be Base64 encoded or decoded:</p>
                <div class="position-relative">
                    <textarea id="inputText" class="code-input" placeholder="Please enter the content to be encoded or decoded..."
                        aria-label="Text input with checkbox"></textarea>
                    <div class="position-absolute top-0 end-0 p-2">
                        <button type="button" class="btn clear-btn" style="padding:0 5px;" title="Clear"
                            onclick="clearText('inputText')">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 移动端操作按钮区域 -->
            <div class="col-12 mobile-buttons" style="margin: 0;padding: 0;">
                <div class="d-flex justify-content-center gap-2 my-3">
                    <button type="button" class="btn btn-primary encode-btn" onclick="encodeText()"
                        style="width: 100px;" data-main="encodeBtn">
                        <i class="bi bi-lightbulb-fill"></i>
                        Encode
                    </button>
                    <button type="button" class="btn btn-info decode-btn" style="width: 100px;" onclick="decodeText()" 
                        data-main="decodeBtn">
                        <i class="bi bi-lightbulb-off"></i>
                        Decode
                    </button>
                    <button type="button" class="btn btn-secondary swap-btn" style="width: 100px;" data-main="swapBtn">
                        <i class="bi bi-repeat"></i>
                        Swap
                    </button>
                </div>
            </div>

            <div class="col output-section">
                <p class="fw-lighter text-start" data-main="outputLabel">Base64 encoding or decoding result:</p>
                <div class="position-relative">
                    <textarea id="outputText" class="code-input" placeholder="The encoding or decoding result will be displayed here..."
                        aria-label="Text input with checkbox"></textarea>
                    <div class="position-absolute top-0 end-0 p-2">
                        <button type="button" class="btn clear-btn" style="padding:0 5px;" title="Clear"
                            onclick="clearText('outputText')">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                    <div class="position-absolute bottom-0 p-2" style="right: 20px;">
                        <button type="button" class="btn copy-btn" style="padding:0 5px;" title="Copy"
                            onclick="copyToClipboard('outputText')">
                            <i class="bi bi-intersect"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 桌面端操作按钮 -->
    <div class="container desktop-buttons">
        <button type="button" class="btn btn-primary encode-btn" onclick="encodeText()" style="width: 120px;" 
            data-main="encodeBtn">
            <i class="bi bi-lightbulb-fill"></i>
            Encode
        </button>
        <button type="button" class="btn btn-info decode-btn" style="width: 120px;" onclick="decodeText()" 
            data-main="decodeBtn">
            <i class="bi bi-lightbulb-off"></i>
            Decode
        </button>
        <button type="button" class="btn btn-secondary swap-btn" style="width: 120px;" data-main="swapBtn">
            <i class="bi bi-repeat"></i>
            Swap
        </button>
    </div>
    <div class="container" style="margin-top: 20px;">
        <div id="alertMessage" class="alert alert-info" role="alert" style="display: none;">
            Please enter the characters to be encoded/decoded in the first text box above.
        </div>
    </div>

    <!-- 设置用户的常用操作 -->
    <div class="container">
        <hr>
                 <!-- 使用flexbox实现自适应布局 -->
         <div class="d-flex flex-wrap gap-3 align-items-end">
             <!-- 自动添加字符串 -->
             <div class="flex-shrink-0" style="min-width: 300px;">
                 <label class="form-label small" data-ops="autoAddString">Auto Add String</label>
                 <div class="input-group">
                     <input type="text" id="autoAddString" class="form-control" placeholder="Maximum 100 characters" maxlength="100"
                         data-bs-toggle="tooltip" data-bs-placement="top" title="Automatically add this string when encoding and remove it when decoding. Used to prevent content from being easily identified.">
                     <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="positionDropdown"
                         data-bs-toggle="dropdown" aria-expanded="false" data-bs-tooltip="tooltip"
                         data-bs-placement="top" title="Select the position to insert the string">
                         <span id="currentPosition">Random Position</span>
                     </button>
                     <ul class="dropdown-menu dropdown-menu-end">
                         <li><a class="dropdown-item position-option" href="#" data-value="random">Random Position</a></li>
                         <li><a class="dropdown-item position-option" href="#" data-value="start">Add at Beginning</a></li>
                         <li><a class="dropdown-item position-option" href="#" data-value="end">Add at End</a></li>
                         <li><a class="dropdown-item position-option" href="#" data-value="random-edge">Random at Beginning or End</a></li>
                     </ul>
                 </div>
             </div>

             <!-- 编码次数 -->
             <div class="flex-shrink-0" style="min-width: 10px;">
                 <label class="form-label small" data-ops="encodeCount">Encode Count</label>
                 <input type="number" id="encodeCount" class="form-control" value="1" min="1" max="100"
                     data-bs-toggle="tooltip" data-bs-placement="top" title="Set the number of Base64 encoding times, multiple encoding can enhance security. Recommended 1-10 times.">
    </div>

             <!-- 自动复制结果开关 -->
             <div class="flex-shrink-0">
                 <div class="form-check form-switch">
                     <input class="form-check-input" type="checkbox" role="switch" id="autoCopyResult" checked
                         data-bs-toggle="tooltip" data-bs-placement="top" title="When enabled, automatically copy the result to clipboard after encoding/decoding without manual copy button click.">
                     <label class="form-check-label small" for="autoCopyResult" data-ops="autoCopyResult">Auto Copy Result</label>
                 </div>
        </div>

             <!-- 自动编解码开关 -->
             <div class="flex-shrink-0">
                 <div class="form-check form-switch">
                     <input class="form-check-input" type="checkbox" role="switch" id="autoDetectSwitch" checked
                         data-bs-toggle="tooltip" data-bs-placement="top" title="When enabled, automatically detect whether the input is Base64 and perform corresponding encoding or decoding operations.">
                     <label class="form-check-label small" for="autoDetectSwitch" data-ops="autoDetectSwitch">Auto Encode/Decode</label>
                 </div>
             </div>
         </div>
    </div>

    <!-- 设置模态框 -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="settingsModalLabel" data-settings="title">⚙️ System Settings</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <!-- 常用操作设置 -->
                        <div class="mb-3">
                            <!-- 自动添加字符串设置 -->
                            <div class="mb-2">
                                <label class="form-label small" data-settings="autoAddStringLabel">Auto Add String</label>
                                <div class="input-group mb-2">
                                    <input type="text" id="modalAutoAddString" class="form-control"
                                        placeholder="Maximum 100 characters" maxlength="100" data-bs-toggle="tooltip"
                                        title="Automatically add this string when encoding and remove it when decoding. Used to prevent content from being easily identified.">
                                </div>
                                <select class="form-select form-select-sm" id="modalAddPosition">
                                    <option value="random">Random Position</option>
                                    <option value="start">Add at Beginning</option>
                                    <option value="end">Add at End</option>
                                    <option value="random-edge">Random at Beginning or End</option>
                                </select>
                        </div>

                            <!-- 编码次数设置 -->
                            <div class="mb-2">
                                <label class="form-label small" data-settings="encodeCountLabel">Encode Count</label>
                                <input type="number" id="modalEncodeCount" class="form-control" value="1" min="1"
                                    max="10" data-bs-toggle="tooltip" title="Set the number of Base64 encoding times, multiple encoding can enhance security. Recommended 1-3 times.">
                        </div>

                            <!-- 开关设置 -->
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="modalAutoCopyResult" checked>
                                <label class="form-check-label" for="modalAutoCopyResult" data-bs-toggle="tooltip"
                                    title="When enabled, automatically copy the result to clipboard after encoding/decoding"
                                    data-settings="autoCopyResultLabel">
                                    Auto Copy Result
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="modalAutoDetectSwitch" checked>
                                <label class="form-check-label" for="modalAutoDetectSwitch" data-bs-toggle="tooltip"
                                    title="When enabled, automatically detect whether the input is Base64 and perform corresponding encoding or decoding operations"
                                    data-settings="autoDetectSwitchLabel">
                                    Auto Encode/Decode
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-settings="cancel">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveSettings()" data-settings="save">Save Settings</button>
                </div>
            </div>
        </div>
    </div>



    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <!-- 导航栏管理 -->
    <script src="/static/js/navbar.js"></script>
    <!-- 多语言支持 -->
    <script src="/static/js/languageswitch.js"></script>

    <script>
        // 全局变量存储设置
        let settings = {
            autoEncode: true,
            autoDetect: true,
            insertRandomChar: false,
            showLineNumbers: false,
            wordWrap: true,
            enableNotifications: true,
            enableSound: false,
            fontSize: '12',
            // 新增的常用操作设置
            autoAddString: '',      // 自动添加的字符串
            addPosition: 'random',  // 添加位置：random, start, end, random-edge
            encodeCount: 1,         // 编码次数
            autoCopyResult: true,   // 自动复制结果
            autoDetectSwitch: true  // 自动编解码开关
        };

        // 用于标识是否是交换操作触发的输入变化
        let isSwapTriggered = false;

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function () {
            loadSettings();
            setupEventListeners();
            initializeTooltips();
            setupCommonOperations();
            // showAlert('请在上方第一个文本框中输入要编码/解码的字符。', 'info');

            // 调试：显示当前设置状态


            // 确保函数在全局作用域中可用
            window.encodeText = encodeText;
            window.decodeText = decodeText;
            window.swapText = swapText;
            window.clearText = clearText;
            window.copyToClipboard = copyToClipboard;


        });

        // 设置事件监听器 - 为各种用户交互绑定事件处理函数
        function setupEventListeners() {
            // 输入框内容变化事件监听 - 当用户在输入框中输入内容时自动触发检测
            $('#inputText').on('input', function () {
                // 只有在启用自动检测且不是交换操作触发的情况下才进行自动处理
                // 使用新的autoDetectSwitch开关来控制自动编解码
                if (settings.autoDetectSwitch && !isSwapTriggered) {
                    autoDetectAndProcess();
                }
            });

            // 插入字符输入框变化监听 - 用于随机字符插入功能
            $('#insertChar').on('input', function () {
                // 如果用户输入了插入字符且启用了随机插入功能
                if ($(this).val() && settings.insertRandomChar) {
                    settings.insertRandomChar = true;
                    saveSettings(); // 保存设置到本地存储
                }
            });

            // 粘贴事件监听 - 处理用户粘贴内容到输入框的情况
            $('#inputText').on('paste', function (e) {
                // 延迟100毫秒执行，确保粘贴内容已经填入输入框
                setTimeout(() => {
                    // 检查是否启用自动检测且不是交换操作触发的
                    // 使用新的autoDetectSwitch开关来控制自动编解码
                    if (settings.autoDetectSwitch && !isSwapTriggered) {
                        autoDetectAndProcess();
                    }
                }, 100);
            });

            // 设置各个按钮的点击事件处理函数
            $('.encode-btn').on('click', encodeText);    // 编码按钮
            $('.decode-btn').on('click', decodeText);    // 解码按钮
            $('.swap-btn').on('click', swapText);        // 交换按钮
        }

        // 初始化Bootstrap提示框 - 为所有带有tooltip属性的元素启用提示功能
        function initializeTooltips() {
            // 初始化所有tooltip
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        // 设置常用操作功能 - 初始化常用操作区域的所有功能和事件监听
        function setupCommonOperations() {
            // 自动添加字符串长度计数更新
            $('#autoAddString').on('input', function () {
                const length = $(this).val().length;
                $('#addStringCount').text(length);
                settings.autoAddString = $(this).val();
                saveSettingsToStorage();
            });

            // 位置选择下拉菜单事件
            $('.position-option').on('click', function (e) {
                e.preventDefault();
                const value = $(this).data('value');
                const text = $(this).text();
                $('#currentPosition').text(text);
                settings.addPosition = value;
                saveSettingsToStorage();
            });

            // 编码次数输入框事件
            $('#encodeCount').on('change', function () {
                const count = parseInt($(this).val());
                if (count >= 1 && count <= 10) {
                    settings.encodeCount = count;
                    saveSettingsToStorage();
                } else {
                    $(this).val(settings.encodeCount);
                    showAlert(window.LanguageManager.getText('messages.encodeCountRange'), 'warning');
                }
            });

            // 自动复制结果开关
            $('#autoCopyResult').on('change', function () {
                settings.autoCopyResult = $(this).is(':checked');
                saveSettingsToStorage();
            });

            // 自动编解码开关 - 同步到原有的自动检测设置
            $('#autoDetectSwitch').on('change', function () {
                const enabled = $(this).is(':checked');
                settings.autoDetectSwitch = enabled;
                settings.autoDetect = enabled; // 同步到原有设置
                $('#autoDetect').prop('checked', enabled); // 同步UI
                saveSettingsToStorage();
            });

            // 同步设置弹框中的控件
            setupModalSync();
        }

        // 设置弹框同步功能 - 确保设置弹框中的控件与主界面保持同步
        function setupModalSync() {
            // 模态框中的自动添加字符串
            $('#modalAutoAddString').on('input', function () {
                const value = $(this).val();
                $('#autoAddString').val(value);
                $('#addStringCount').text(value.length);
                settings.autoAddString = value;
                saveSettingsToStorage();
            });

            // 模态框中的位置选择
            $('#modalAddPosition').on('change', function () {
                const value = $(this).val();
                const text = $(this).find('option:selected').text();
                $('#currentPosition').text(text);
                settings.addPosition = value;
                saveSettingsToStorage();
            });

            // 模态框中的编码次数
            $('#modalEncodeCount').on('change', function () {
                const count = parseInt($(this).val());
                if (count >= 1 && count <= 10) {
                    $('#encodeCount').val(count);
                    settings.encodeCount = count;
                    saveSettingsToStorage();
                } else {
                    $(this).val(settings.encodeCount);
                }
            });

            // 模态框中的自动复制开关
            $('#modalAutoCopyResult').on('change', function () {
                const enabled = $(this).is(':checked');
                $('#autoCopyResult').prop('checked', enabled);
                settings.autoCopyResult = enabled;
                saveSettingsToStorage();
            });

            // 模态框中的自动编解码开关
            $('#modalAutoDetectSwitch').on('change', function () {
                const enabled = $(this).is(':checked');
                $('#autoDetectSwitch').prop('checked', enabled);
                settings.autoDetectSwitch = enabled;
                settings.autoDetect = enabled; // 同步到原有设置
                $('#autoDetect').prop('checked', enabled);
                saveSettingsToStorage();
            });
        }

        // 自动检测并处理编码/解码功能 - 根据输入内容智能判断是否需要编码或解码
        function autoDetectAndProcess() {
            // 关键修复：如果是交换操作触发的输入变化，跳过自动处理
            // 这确保了交换功能不会触发意外的编码/解码操作
            if (isSwapTriggered) {
    
                isSwapTriggered = false; // 重置标志，为下次操作做准备
                return;
            }

            // 获取输入框中的文本内容并去除首尾空格
            const text = $('#inputText').val().trim();

            // 如果输入为空，清空输出框
            if (!text) {
                clearOutput();
                return;
            }

            // 调试信息：显示检测过程，便于开发者调试



            // 智能检测输入内容的类型：Base64编码 vs 普通文本
            if (isBase64(text)) {
                // 如果检测到是Base64编码，执行自动解码

                autoDecode();
            } else {
                // 如果不是Base64编码，执行自动编码

                autoEncode();
            }
        }

        // 检查是否为Base64编码
        function isBase64(str) {
            // 移除可能的空白字符
            str = str.replace(/\s/g, '');

            // 空字符串不是Base64
            if (!str) {
                return false;
            }

            // Base64字符串长度必须是4的倍数
            if (str.length % 4 !== 0) {
                return false;
            }

            // 检查是否只包含Base64字符
            const base64Regex = /^[A-Za-z0-9+/]*={0,2}$/;
            if (!base64Regex.test(str)) {
                return false;
            }

            // 尝试解码验证
            try {
                atob(str);
                return true;
            } catch (err) {
                return false;
            }
        }

        // 检查是否为可读文本
        function isReadableText(str) {
            // 检查是否包含可读字符
            const readableChars = str.match(/[a-zA-Z0-9\u4e00-\u9fa5\s.,!?;:'"()[\]{}]/g);
            return readableChars && readableChars.length > str.length * 0.3;
        }

        // 安全的中文Base64解码函数
        function safeBase64Decode(str) {
            try {
                // 首先尝试直接解码
                const binaryString = atob(str);

                // 尝试使用TextDecoder解码（支持UTF-8）
                if (typeof TextDecoder !== 'undefined') {
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    return new TextDecoder('utf-8').decode(bytes);
                } else {
                    // 降级到传统方法，但使用更安全的方式
                    try {
                        return decodeURIComponent(escape(binaryString));
                    } catch (e) {
                        // 如果escape方法失败，尝试直接返回二进制字符串
                        return binaryString;
                    }
                }
            } catch (e) {
                throw new Error('Base64解码失败: ' + e.message);
            }
        }

        // 安全的中文Base64编码函数
        function safeBase64Encode(str) {
            try {
                // 尝试使用TextEncoder编码（支持UTF-8）
                if (typeof TextEncoder !== 'undefined') {
                    const encoder = new TextEncoder();
                    const bytes = encoder.encode(str);
                    let binaryString = '';
                    for (let i = 0; i < bytes.length; i++) {
                        binaryString += String.fromCharCode(bytes[i]);
                    }
                    return btoa(binaryString);
                } else {
                    // 降级到传统方法
                    return btoa(unescape(encodeURIComponent(str)));
                }
            } catch (e) {
                throw new Error('Base64编码失败: ' + e.message);
            }
        }

        // 根据位置设置插入字符串 - 实现自动添加字符串功能的核心逻辑
        function insertStringAtPosition(text, insertString, position) {
            if (!insertString) return text;

            switch (position) {
                case 'start':
                    // 在开头添加
                    return insertString + text;
                case 'end':
                    // 在结尾添加
                    return text + insertString;
                case 'random':
                    // 在随机位置添加
                    const randomPos = Math.floor(Math.random() * (text.length + 1));
                    return text.slice(0, randomPos) + insertString + text.slice(randomPos);
                case 'random-edge':
                    // 随机在开头或结尾添加
                    return Math.random() < 0.5 ? insertString + text : text + insertString;
                default:
                    return text;
            }
        }

        // 从文本中移除指定字符串 - 解码时移除自动添加的字符串
        function removeInsertedString(text, insertString) {
            if (!insertString) return text;

            // 移除所有出现的插入字符串（支持多次出现的情况）
            return text.replace(new RegExp(escapeRegExp(insertString), 'g'), '');
        }

        // 转义正则表达式特殊字符 - 确保字符串能正确用于正则表达式
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // 多次编码功能 - 根据设置的编码次数进行多次Base64编码
        function multipleEncode(text, times) {
            let result = text;
            for (let i = 0; i < times; i++) {
                result = safeBase64Encode(result);
            }
            return result;
        }

        // 多次解码功能 - 尝试多次Base64解码直到得到可读文本
        function multipleDecode(text) {
            let result = text;
            let decodeCount = 0;
            const maxAttempts = settings.encodeCount || 10; // 最大尝试次数

            while (decodeCount < maxAttempts) {
                try {
                    const decoded = safeBase64Decode(result);
                    decodeCount++;

                    // 检查解码结果是否仍然是Base64格式
                    if (isBase64(decoded) && decodeCount < maxAttempts) {
                        result = decoded;
                    } else {
                        // 不是Base64格式或达到最大次数，返回当前结果
                        return { result: decoded, decodeTimes: decodeCount };
                    }
                } catch (e) {
                    // 解码失败，返回上一次的结果
                    break;
                }
            }

            return { result: result, decodeTimes: decodeCount };
        }

        // 独立的本地存储保存函数 - 避免与原有保存函数冲突
        function saveSettingsToStorage() {
            localStorage.setItem('base64Settings', JSON.stringify(settings));
        }

        // 自动复制功能 - 当开启自动复制时，自动复制结果到剪贴板
        function autoCopyToClipboard(text) {
            if (!settings.autoCopyResult) return;

            try {
                // 保存当前焦点元素，防止复制操作导致焦点丢失
                const activeElement = document.activeElement;

                // 使用现代的Clipboard API（如果支持）
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(text).then(() => {
                        showAlert('结果已自动复制到剪贴板！', 'success');
                    }).catch(() => {
                        // 降级到传统方法
                        fallbackCopyToClipboard(text, activeElement);
                    });
                } else {
                    // 降级到传统方法
                    fallbackCopyToClipboard(text, activeElement);
                }
            } catch (e) {
                console.error('自动复制失败:', e);
            }
        }

        // 传统复制方法的降级函数 - 在不支持现代API时使用
        function fallbackCopyToClipboard(text, activeElement) {
            try {
                // 创建临时textarea元素进行复制
                const tempElement = document.createElement('textarea');
                tempElement.value = text;
                tempElement.style.position = 'fixed';
                tempElement.style.left = '-9999px';
                tempElement.style.top = '-9999px';
                document.body.appendChild(tempElement);

                // 执行复制操作
                tempElement.select();
                tempElement.setSelectionRange(0, 99999);
                document.execCommand('copy');
                document.body.removeChild(tempElement);

                // 恢复焦点到原来的元素
                if (activeElement && activeElement.focus) {
                    activeElement.focus();
                }

                // 显示自动复制提示
                showAlert(window.LanguageManager.getText('messages.autoCopied'), 'success');
            } catch (e) {
                console.error('传统复制方法失败:', e);
            }
        }

        // 自动编码（不显示提示）- 支持自动添加字符串和多次编码
        function autoEncode() {
            let text = $('#inputText').val();
            if (!text.trim()) return;

            try {
                // 第一步：添加自定义字符串（如果设置了）
                if (settings.autoAddString) {
                    text = insertStringAtPosition(text, settings.autoAddString, settings.addPosition);
                }

                // 第二步：如果有插入字符且启用了随机插入（保持向后兼容）
                if ($('#insertChar').val() && settings.insertRandomChar) {
                    text = insertRandomChar(text, $('#insertChar').val());
                }

                // 第三步：进行多次编码
                const encoded = multipleEncode(text, settings.encodeCount);
                $('#outputText').val(encoded);
                updateButtonStates('encode');

                // 第四步：自动复制结果（如果开启）
                autoCopyToClipboard(encoded);
            } catch (e) {
    
                // 自动编码失败时不显示错误
            }
        }

        // 自动解码（不显示提示）- 支持多次解码和自动移除字符串
        function autoDecode() {
            let text = $('#inputText').val();
            if (!text.trim()) return;

            try {
                // 第一步：进行多次解码，获取解码结果和解码次数
                const decodeResult = multipleDecode(text);
                let decoded = decodeResult.result;

                // 第二步：移除自定义添加的字符串（如果设置了）
                if (settings.autoAddString) {
                    decoded = removeInsertedString(decoded, settings.autoAddString);
                }

                // 第三步：如果有插入字符且启用了随机插入，移除插入的字符（保持向后兼容）
                if ($('#insertChar').val() && settings.insertRandomChar) {
                    decoded = removeInsertedChar(decoded, $('#insertChar').val());
                }

                $('#outputText').val(decoded);
                updateButtonStates('decode');

                // 第四步：自动复制结果（如果开启）
                autoCopyToClipboard(decoded);
            } catch (e) {
    
                // 自动解码失败时不显示错误
            }
        }

        // Base64编码功能 - 手动编码，支持所有新功能
        function encodeText() {
            let text = $('#inputText').val();
            if (!text.trim()) {
                showAlert(window.LanguageManager.getText('messages.inputRequired'), 'warning');
                return;
            }

            try {
                // 第一步：添加自定义字符串（如果设置了）
                if (settings.autoAddString) {
                    text = insertStringAtPosition(text, settings.autoAddString, settings.addPosition);
                }

                // 第二步：如果有插入字符且启用了随机插入（保持向后兼容）
                if ($('#insertChar').val() && settings.insertRandomChar) {
                    text = insertRandomChar(text, $('#insertChar').val());
                }

                // 第三步：进行多次编码
                const encoded = multipleEncode(text, settings.encodeCount);
                $('#outputText').val(encoded);

                // 显示成功提示，包含编码次数信息
                const message = settings.encodeCount > 1 ?
                    window.LanguageManager.formatMessage('messages.encodeSuccessMultiple', { count: settings.encodeCount }) :
                    window.LanguageManager.getText('messages.encodeSuccess');
                showAlert(message, 'success');
                updateButtonStates('encode');

                // 第四步：自动复制结果（如果开启）
                autoCopyToClipboard(encoded);
            } catch (e) {
                showAlert(window.LanguageManager.getText('messages.encodeError') + e.message, 'danger');
            }
        }

        // Base64解码功能 - 手动解码，支持所有新功能
        function decodeText() {
            let text = $('#inputText').val();
            if (!text.trim()) {
                showAlert(window.LanguageManager.getText('messages.inputRequiredDecode'), 'warning');
                return;
            }

            try {
                // 第一步：进行多次解码，获取解码结果和解码次数
                const decodeResult = multipleDecode(text);
                let decoded = decodeResult.result;

                // 第二步：移除自定义添加的字符串（如果设置了）
                if (settings.autoAddString) {
                    decoded = removeInsertedString(decoded, settings.autoAddString);
                }

                // 第三步：如果有插入字符且启用了随机插入，移除插入的字符（保持向后兼容）
                if ($('#insertChar').val() && settings.insertRandomChar) {
                    decoded = removeInsertedChar(decoded, $('#insertChar').val());
                }

                $('#outputText').val(decoded);

                // 显示成功提示，包含解码次数信息
                const message = decodeResult.decodeTimes > 1 ?
                    window.LanguageManager.formatMessage('messages.decodeSuccessMultiple', { count: decodeResult.decodeTimes }) :
                    window.LanguageManager.getText('messages.decodeSuccess');
                showAlert(message, 'success');
                updateButtonStates('decode');

                // 第四步：自动复制结果（如果开启）
                autoCopyToClipboard(decoded);
            } catch (e) {
                showAlert(window.LanguageManager.getText('messages.decodeError'), 'danger');
            }
        }

        // 随机插入字符
        function insertRandomChar(text, char) {
            const chars = text.split('');
            const insertPosition = Math.floor(Math.random() * (chars.length + 1));
            chars.splice(insertPosition, 0, char);
            return chars.join('');
        }

        // 移除插入的字符
        function removeInsertedChar(text, char) {
            return text.replace(new RegExp(char, 'g'), '');
        }

        // 交换文本内容功能 - 将输入框和输出框的内容进行交换
        function swapText() {
    
            // 设置交换触发标志为true，防止自动检测功能在交换时触发编码/解码
            // 必须在获取值之前设置，确保整个交换过程不被干扰
            isSwapTriggered = true;

            // 使用jQuery获取当前两个文本框的内容
            const inputText = $('#inputText').val();
            const outputText = $('#outputText').val();

    
    

            // 临时禁用所有自动处理事件，确保交换过程不被打断
            const originalAutoDetect = settings.autoDetect;
            settings.autoDetect = false;

            // 执行内容交换：将输出框内容放入输入框，将输入框内容放入输出框
            $('#inputText').val(outputText);
            $('#outputText').val(inputText);

    
    

            // 恢复自动检测设置并重置交换标志
            setTimeout(() => {
                settings.autoDetect = originalAutoDetect;
                isSwapTriggered = false;
            }, 50);

            // 显示操作成功提示信息
            showAlert(window.LanguageManager.getText('messages.swapped'), 'info');
        }

        // 复制到剪贴板 - 手动复制功能，保持原有焦点
        function copyToClipboard(elementId) {
            try {
            const element = $('#' + elementId)[0];
                const text = element.value;

                // 保存当前焦点元素
                const activeElement = document.activeElement;

                // 使用现代的Clipboard API（如果支持）
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(text).then(() => {
                        showAlert(window.LanguageManager.getText('messages.copied'), 'success');
                    }).catch(() => {
                        // 降级到传统方法
                        fallbackManualCopy(element, activeElement);
                    });
                } else {
                    // 降级到传统方法
                    fallbackManualCopy(element, activeElement);
                }
            } catch (e) {
                console.error('复制失败:', e);
                showAlert(window.LanguageManager.getText('messages.copyFailed'), 'danger');
            }
        }

        // 传统手动复制方法的降级函数
        function fallbackManualCopy(element, activeElement) {
            try {
            element.select();
            element.setSelectionRange(0, 99999); // 兼容移动端
            document.execCommand('copy');

                // 恢复原来的焦点（如果原来就在某个输入框中）
                if (activeElement && activeElement !== element && activeElement.focus) {
                    setTimeout(() => {
                        activeElement.focus();
                    }, 100);
                }

                showAlert(window.LanguageManager.getText('messages.copied'), 'success');
            } catch (e) {
                console.error('传统复制方法失败:', e);
                showAlert(window.LanguageManager.getText('messages.copyFailed'), 'danger');
            }
        }

        // 清空文本
        function clearText(elementId) {
            $('#' + elementId).val('');
            if (elementId === 'inputText') {
                clearOutput();
            }
            showAlert(window.LanguageManager.getText('messages.cleared'), 'info');
        }

        // 清空输出
        function clearOutput() {
            $('#outputText').val('');
        }

        // 更新按钮状态
        function updateButtonStates(action) {
            if (action === 'encode') {
                $('.encode-btn').removeClass('btn-light').addClass('btn-primary');
                $('.decode-btn').removeClass('btn-primary').addClass('btn-light');
            } else if (action === 'decode') {
                $('.decode-btn').removeClass('btn-light').addClass('btn-primary');
                $('.encode-btn').removeClass('btn-primary').addClass('btn-light');
            }
        }

        // 显示提示信息
        function showAlert(message, type = 'info') {
            $('#alertMessage')
                .removeClass()
                .addClass(`alert alert-${type}`)
                .text(message)
                .show();

            // 3秒后自动隐藏
            setTimeout(() => {
                $('#alertMessage').hide();
            }, 10000);
        }

        // 保存设置 - 包含所有新的常用操作设置
        function saveSettings() {
            // 原有设置项
            settings.autoEncode = $('#autoEncode').is(':checked');
            settings.autoDetect = $('#autoDetect').is(':checked');
            settings.insertRandomChar = $('#insertRandomChar').is(':checked');
            settings.showLineNumbers = $('#showLineNumbers').is(':checked');
            settings.wordWrap = $('#wordWrap').is(':checked');
            settings.enableNotifications = $('#enableNotifications').is(':checked');
            settings.enableSound = $('#enableSound').is(':checked');
            settings.fontSize = $('#fontSize').val();

            // 新增的常用操作设置项
            settings.autoAddString = $('#modalAutoAddString').val() || $('#autoAddString').val();
            settings.addPosition = $('#modalAddPosition').val() || settings.addPosition;
            settings.encodeCount = parseInt($('#modalEncodeCount').val()) || parseInt($('#encodeCount').val()) || 1;
            settings.autoCopyResult = $('#modalAutoCopyResult').is(':checked');
            settings.autoDetectSwitch = $('#modalAutoDetectSwitch').is(':checked');

            // 确保编码次数在有效范围内
            if (settings.encodeCount < 1 || settings.encodeCount > 10) {
                settings.encodeCount = 1;
            }

            localStorage.setItem('base64Settings', JSON.stringify(settings));
            showAlert(window.LanguageManager.getText('messages.settingsSaved'), 'success');

            // 应用设置到界面
            applySettings();
            syncSettingsToUI();

            // 关闭设置模态框
            const settingsModal = document.getElementById('settingsModal');
            const modal = bootstrap.Modal.getInstance(settingsModal);
            if (modal) {
                modal.hide();
            } else {
                // 如果没有实例，创建一个新的并立即关闭
                const newModal = new bootstrap.Modal(settingsModal);
                newModal.hide();
            }
        }

        // 加载设置 - 加载所有设置项包括新的常用操作设置
        function loadSettings() {
            const savedSettings = localStorage.getItem('base64Settings');
            if (savedSettings) {
                const loaded = JSON.parse(savedSettings);
                // 合并设置，确保新字段有默认值
                settings = { ...settings, ...loaded };
            }

            // 应用原有设置到UI
            $('#autoEncode').prop('checked', settings.autoEncode);
            $('#autoDetect').prop('checked', settings.autoDetect);
            $('#insertRandomChar').prop('checked', settings.insertRandomChar);
            $('#showLineNumbers').prop('checked', settings.showLineNumbers);
            $('#wordWrap').prop('checked', settings.wordWrap);
            $('#enableNotifications').prop('checked', settings.enableNotifications);
            $('#enableSound').prop('checked', settings.enableSound);
            $('#fontSize').val(settings.fontSize);

            // 应用设置
            applySettings();
            syncSettingsToUI();
        }

        // 同步设置到UI界面 - 确保主界面和设置弹框显示一致的设置值
        function syncSettingsToUI() {
            // 同步常用操作设置到主界面
            $('#autoAddString').val(settings.autoAddString);
            $('#encodeCount').val(settings.encodeCount);
            $('#autoCopyResult').prop('checked', settings.autoCopyResult);
            $('#autoDetectSwitch').prop('checked', settings.autoDetectSwitch);
            $('#addStringCount').text(settings.autoAddString.length);

            // 更新位置显示
            const positionTexts = {
                'random': '随机位置',
                'start': '在开头添加',
                'end': '在结尾添加',
                'random-edge': '随机在开头或结尾'
            };
            $('#currentPosition').text(positionTexts[settings.addPosition] || '随机位置');

            // 同步常用操作设置到设置弹框
            $('#modalAutoAddString').val(settings.autoAddString);
            $('#modalAddPosition').val(settings.addPosition);
            $('#modalEncodeCount').val(settings.encodeCount);
            $('#modalAutoCopyResult').prop('checked', settings.autoCopyResult);
            $('#modalAutoDetectSwitch').prop('checked', settings.autoDetectSwitch);

            // 同步自动编解码设置（新旧设置保持一致）
            $('#autoDetect').prop('checked', settings.autoDetectSwitch);
        }

        // 应用设置
        function applySettings() {
            // 应用字体大小
            applyFontSize();

            // 强制应用自动换行设置
            $('textarea.code-input').css({
                'white-space': 'pre-wrap',
                'word-wrap': 'break-word',
                'word-break': 'break-all',
                'overflow-wrap': 'break-word'
            });

            // 应用行号显示（如果需要的话）
            if (settings.showLineNumbers) {
                // 这里可以添加行号显示的逻辑
            }
        }

        // 应用字体大小
        function applyFontSize() {
            // 设置最小字体大小为10px，最大为20px
            const fontSize = Math.max(10, Math.min(20, parseInt(settings.fontSize)));
            $('textarea').css('font-size', fontSize + 'px');
        }

        // 清空所有内容
        function clearAll() {
            $('#inputText').val('');
            $('#outputText').val('');
            showAlert('所有内容已清空。', 'info');
        }

        // 语言切换功能
        function switchLanguage(lang, langName, flag) {
            // 更新按钮显示
            $('.dropdown-toggle').html(`${flag} ${langName}`);

            // 保存语言选择
            localStorage.setItem('selectedLanguage', JSON.stringify({
                lang: lang,
                name: langName,
                flag: flag
            }));
        }

        // 添加键盘快捷键支持
        $(document).on('keydown', function (e) {
            // Ctrl+Enter 编码
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                encodeText();
            }
            // Ctrl+Shift+Enter 解码
            if (e.ctrlKey && e.shiftKey && e.key === 'Enter') {
                e.preventDefault();
                decodeText();
            }
            // Ctrl+S 交换
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                swapText();
            }
            // Ctrl+L 清空
            if (e.ctrlKey && e.key === 'l') {
                e.preventDefault();
                clearAll();
            }
        });

        // 清空所有内容
        function clearAll() {
            $('#inputText').val('');
            $('#outputText').val('');
            $('#insertChar').val('');
            updateCharCount();
            showAlert(window.LanguageManager.getText('messages.cleared'), 'info');
        }

        // 增强的Base64检测函数
        function isBase64(str) {
            if (str === '' || str.trim() === '') {
                return false;
            }

            try {
                // 检查是否只包含Base64字符
                const base64Regex = /^[A-Za-z0-9+/]*={0,2}$/;
                if (!base64Regex.test(str)) {
                    return false;
                }

                // 尝试解码
                const decoded = atob(str);
                // 检查解码结果是否有效
                return btoa(decoded) === str;
            } catch (err) {
                return false;
            }
        }

        // 增强的可读文本检测
        function isReadableText(str) {
            if (!str || str.length === 0) return false;

            // 检查是否包含可读字符（包括中文）
            const readableChars = str.match(/[a-zA-Z0-9\u4e00-\u9fa5\s.,!?;:'"()[\]{}]/g);
            const readableRatio = readableChars ? readableChars.length / str.length : 0;

            // 如果可读字符比例超过50%，认为是可读文本
            return readableRatio > 0.5;
        }
    </script>
</body>

<style>
    html,
    body {
        background: rgb(245 246 255);
        min-width: 100%;
        min-height: 100%;
        margin: 0;
        padding: 0;
    }

    /* 强化textarea样式，确保能够调整大小和自动换行 */
    .code-input {
        background: #fff !important;
        border-radius: 10px !important;
        box-shadow: 0 2px 8px 0 rgba(96, 114, 252, .05) !important;
        padding: 12px !important;
        min-height: 300px !important;
        height: 50vh;
        width: 100%;
        border: 1px solid #fff;
        resize: vertical !important;
        /* 强制自动换行设置 */
        white-space: pre-wrap !important;
        word-wrap: break-word !important;
        word-break: break-all !important;
        overflow-wrap: break-word !important;
        /* 确保有滚动条 */
        overflow-y: auto !important;
    }


    /* 鼠标悬浮时的提示效果 */
    .code-input:hover {
        border-color: #86b7fe;
        box-shadow: 0 0 0 1px rgba(13, 110, 253, 0.1);
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    /* 移动端布局优化 - 上下排列和按钮位置调整 */
    @media (max-width: 768px) {

        /* 确保row容器支持flexbox order */
        .textarea-container {
            display: flex !important;
            flex-direction: column !important;
        }

        /* 移动端输入框上下排列 */
        .textarea-container .input-section,
        .textarea-container .output-section {
            flex: 0 0 100% !important;
            max-width: 100% !important;
            margin-bottom: 20px;
        }

        /* 移动端输入框高度调整 */
        .code-input {
            min-height: 200px !important;
            height: 30vh !important;
            background: #fff !important;
            border-radius: 10px !important;
            box-shadow: 0 2px 8px 0 rgba(96, 114, 252, .05) !important;
            border: 1px solid #fff !important;
        }

        /* 移动端显示中间按钮，隐藏桌面按钮 */
        .mobile-buttons {
            display: block !important;
            order: 2;
            /* 确保在输入框和输出框之间 */
        }

        .desktop-buttons {
            display: none !important;
        }

        /* 调整输入框顺序 */
        .input-section {
            order: 1;
        }

        .output-section {
            order: 3;
        }

        /* 移动端按钮样式优化 */
        .mobile-buttons .btn {
            font-size: 14px;
            padding: 10px 15px;
            margin: 0 5px;
        }

        /* 移动端按钮容器样式 */
        .mobile-buttons {
            padding: 15px 0;
            background: rgba(245, 246, 255, 0.5);
        border-radius: 10px;
            margin: 15px 0;
        }

        /* 移动端调整手柄更明显 */
        .code-input::-webkit-resizer {
            background-size: 12px 12px;
        }

        /* 移动端文本框边距调整 */
        .input-section,
        .output-section {
            margin-bottom: 0;
        }
    }

    /* 桌面端隐藏移动端按钮 */
    @media (min-width: 769px) {
        .mobile-buttons {
            display: none !important;
        }

        .desktop-buttons {
            display: block !important;
        }
    }

    div {
        box-sizing: border-box;
    }



    /* 常用操作区域样式优化 - 确保在各种屏幕尺寸下都有良好的显示效果 */
    .d-flex.flex-wrap.gap-3 {
        gap: 1rem !important;
        /* 确保元素间有适当的间距 */
    }

    /* 提示框样式优化 - 确保tooltip在移动端也能正常显示 */
    .tooltip {
        font-size: 0.875rem;
        max-width: 250px;
    }

    /* 表单控件样式优化 - 统一表单元素的外观 */
    .form-control,
    .form-select {
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    /* 开关样式优化 - 使开关在移动端更容易点击 */
    .form-check-input[type="checkbox"] {
        cursor: pointer;
    }

    /* 小标签样式 - 统一小标签的外观 */
    .form-label.small {
        font-weight: 500;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }
</style>

</html>