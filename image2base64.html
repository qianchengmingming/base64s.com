<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>在线图片转Base64编码工具 | Base64图片解析器</title>
    <link rel="icon" href="/static/images/logo.svg" type="image/png">
    <meta name="keywords" content="图片转base64,base64转图片,图片编码,PNG转base64,JPG转base64,图片base64工具">
    <meta name="description" content="免费在线图片Base64编码解码工具。支持JPG、PNG、GIF、SVG、WebP格式互转。用于网页开发、邮件嵌入和数据URL生成。">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- 导航栏样式 -->
    <link rel="stylesheet" href="/static/css/navbar.css">
</head>

<body>
    <!-- 第1栏：导航栏容器 -->
    <div id="navbar-container"></div>

    <!-- 第2栏：介绍栏 -->
    <div class="container intro-section" style="margin-top: 10px; margin-bottom: 20px;">
        <div class="d-flex align-items-center justify-content-start">
            <h1 class="me-4" style="margin: 0; font-size: 1.2rem; font-weight: 600;" data-image="title">图片Base64编码解码</h1>
            <h2 class="mb-0" style="font-size: 1rem; color: #6c757d; font-weight: 400;" data-image="subtitle">支持图片转Base64编码和Base64解析为图片，支持多种图片格式</h2>
        </div>
    </div>

    <!-- 第3栏：主要内容区 -->
    <div class="container text-center" style="margin-top: 10px; margin-bottom: 10px;">
        <div class="row textarea-container">
            <!-- 左侧：图片上传/显示区域 -->
            <div class="col input-section">
                <p class="fw-lighter text-start" data-image="imageLabel">请上传图片文件或查看Base64解码后的图片：</p>
                <div class="position-relative">
                    <!-- 图片上传区域 -->
                    <div id="uploadArea" class="image-display-area">
                        <div class="upload-content">
                            <i class="bi bi-cloud-upload display-4 text-muted"></i>
                            <p class="mt-2 mb-2" data-image="dragDropText">拖拽图片到此处或点击选择</p>
                            <p class="text-muted small" data-image="supportedFormats">支持 JPG、PNG、GIF、WebP、SVG（最大50MB）</p>
                            <input type="file" id="imageInput" accept="image/*" style="display: none;">
                            <button type="button" class="btn btn-primary btn-sm" onclick="selectImage()" data-image="uploadBtn">选择图片</button>
                        </div>
                    </div>
                    
                    <!-- 图片预览/显示区域 -->
                    <div id="imageDisplay" class="image-display-area" style="display: none;">
                        <img id="displayImg" class="preview-image">
                        <div class="image-info mt-2">
                            <span id="imageInfo" class="text-muted small"></span>
                        </div>
                    </div>
                    
                    <!-- 清空按钮 -->
                    <div class="position-absolute top-0 end-0 p-2">
                        <button type="button" class="btn clear-btn" style="padding:0 5px;" title="清空" onclick="clearImage()" data-main-title="clearBtn">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 移动端操作按钮区域 -->
            <div class="col-12 mobile-buttons" style="margin: 0;padding: 0;">
                <div class="d-flex justify-content-center gap-2 my-3">
                    <button type="button" class="btn btn-primary encode-btn" onclick="imageToBase64()" style="width: 80px;">
                        <i class="bi bi-arrow-right"></i>
                        <span data-image="encodeBtn">编码</span>
                    </button>
                    <button type="button" class="btn btn-info decode-btn" style="width: 80px;" onclick="base64ToImage()">
                        <i class="bi bi-arrow-left"></i>
                        <span data-image="decodeBtn">解码</span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="swapContent()" style="width: 80px;">
                        <i class="bi bi-arrow-left-right"></i>
                        <span data-image="swapBtn">交换</span>
                    </button>
                </div>
            </div>

            <!-- 右侧：Base64输入/显示区域 -->
            <div class="col output-section">
                <p class="fw-lighter text-start" data-image="base64Label">Base64编码结果或输入Base64字符串进行解码：</p>
                <div class="position-relative">
                    <textarea id="base64Text" class="code-input" placeholder="Base64编码结果将显示在这里..." aria-label="Base64 input/output" data-image-placeholder="base64Placeholder"></textarea>
                    <div class="position-absolute top-0 end-0 p-2">
                        <button type="button" class="btn clear-btn" style="padding:0 5px;" title="清空" onclick="clearBase64()" data-main-title="clearBtn">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                    <div class="position-absolute bottom-0 p-2" style="right: 20px;">
                        <button type="button" class="btn copy-btn" style="padding:0 5px;" title="复制" onclick="copyBase64()" data-main-title="copyBtn">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 第4栏：桌面端操作按钮 -->
    <div class="container desktop-buttons">
        <div class="d-flex justify-content-start gap-2">
            <button type="button" class="btn btn-primary encode-btn" onclick="imageToBase64()" style="min-width: 120px;">
                <i class="bi bi-arrow-right"></i>
                <span data-image="encodeBtn">编码</span>
            </button>
            <button type="button" class="btn btn-info decode-btn" style="min-width: 120px;" onclick="base64ToImage()">
                <i class="bi bi-arrow-left"></i>
                <span data-image="decodeBtn">解码</span>
            </button>
            <button type="button" class="btn btn-secondary" onclick="swapContent()">
                <i class="bi bi-arrow-left-right"></i>
                <span data-image="swapBtn">交换</span>
            </button>
            <button type="button" class="btn btn-outline-primary" onclick="copyBase64()">
                <i class="bi bi-clipboard"></i>
                <span data-image="copyBase64Btn">复制Base64</span>
            </button>
            <button type="button" class="btn btn-outline-primary" onclick="copyImage()">
                <i class="bi bi-image"></i>
                <span data-image="copyImageBtn">复制图片</span>
            </button>
            <button type="button" class="btn btn-outline-primary" onclick="downloadImage()">
                <i class="bi bi-download"></i>
                <span data-image="downloadBtn">下载图片</span>
            </button>
            <button type="button" class="btn btn-outline-primary" onclick="clearAll()">
                <i class="bi bi-trash"></i>
                <span data-image="clearAllBtn">清空</span>
            </button>
        </div>
    </div>
    <!-- 第4栏：提示消息区域 -->
    <div class="container" style="margin-top: 20px;">
        <div id="alertMessage" class="alert alert-info" role="alert" style="display: none;" data-image="initialMessage">
            请选择图片文件或粘贴Base64字符串开始转换。
        </div>
    </div>

    <!-- 第5栏：设置区域 -->
    <div class="container">
        <hr>
        <div class="d-flex flex-wrap gap-3 align-items-end" style="margin-bottom: 20px;">
            <!-- 输出格式设置 -->
            <div class="flex-shrink-0" style="min-width: 250px;">
                <label class="form-label small" data-image="outputFormatLabel">输出格式</label>
                <select class="form-select" id="outputFormat">
                    <option value="base64" data-image="formatBase64">Base64 value</option>
                    <option value="datauri" data-image="formatDataURI">Data URI</option>
                    <option value="css" data-image="formatCSS">CSS Background Image</option>
                    <option value="favicon" data-image="formatFavicon">HTML Favicon</option>
                    <option value="hyperlink" data-image="formatHyperlink">HTML Hyperlink</option>
                    <option value="img" data-image="formatImg">HTML Image</option>
                    <option value="iframe" data-image="formatIframe">HTML Iframe</option>
                    <option value="jsimage" data-image="formatJSImage">JavaScript Image</option>
                    <option value="jspopup" data-image="formatJSPopup">JavaScript Popup</option>
                    <option value="json" data-image="formatJSON">JSON</option>
                    <option value="xml" data-image="formatXML">XML</option>
                </select>
            </div>

            <!-- 自动编解码开关 -->
            <div class="flex-shrink-0">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="autoEncodeDecode" checked>
                    <label class="form-check-label small" for="autoEncodeDecode" data-image="autoEncodeDecodeLabel">自动编解码</label>
                </div>
            </div>

            <!-- 自动复制开关 -->
            <div class="flex-shrink-0">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="autoCopyBase64" checked>
                    <label class="form-check-label small" for="autoCopyBase64" data-image="autoCopyLabel">自动复制结果</label>
                </div>
            </div>

            <!-- 自动下载开关 -->
            <div class="flex-shrink-0">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="autoDownload">
                    <label class="form-check-label small" for="autoDownload" data-image="autoDownloadLabel">自动下载图片</label>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript引用 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <!-- 导航栏管理 -->
    <script src="/static/js/navbar.js"></script>
    <!-- 多语言支持 -->
    <script src="/static/js/languageswitch.js"></script>

    <!-- 页面专用JavaScript -->
    <script>
        // 图片转换设置
        let imageSettings = {
            autoDownload: false,
            autoCopyBase64: true,
            autoEncodeDecode: true,
            outputFormat: 'base64'
        };

        // 当前处理的文件和数据
        let currentFile = null;
        let currentBase64 = null;
        let currentImageSrc = null;

        // 页面加载完成后初始化
        $(document).ready(function() {
            loadImageSettings();
            initializeImageUpload();
            initializeTooltips();
            setupImageEventListeners();
            showAlert('请选择图片文件或粘贴Base64字符串开始转换。', 'info');

            // 确保函数在全局作用域中可用
            window.imageToBase64 = imageToBase64;
            window.base64ToImage = base64ToImage;
            window.swapContent = swapContent;
            window.clearImage = clearImage;
            window.clearBase64 = clearBase64;
            window.copyBase64 = copyBase64;
            window.copyImage = copyImage;
            window.downloadImage = downloadImage;
            window.selectImage = selectImage;
            window.clearAll = clearAll;
        });

        // 加载图片转换设置
        function loadImageSettings() {
            const savedSettings = localStorage.getItem('imageSettings');
            if (savedSettings) {
                try {
                    imageSettings = {...imageSettings, ...JSON.parse(savedSettings)};
                } catch (e) {
                    // 加载图片设置失败
                }
            }
            
            // 更新UI
            $('#autoDownload').prop('checked', imageSettings.autoDownload);
            $('#autoCopyBase64').prop('checked', imageSettings.autoCopyBase64);
            $('#autoEncodeDecode').prop('checked', imageSettings.autoEncodeDecode);
            $('#outputFormat').val(imageSettings.outputFormat);
        }

        // 保存图片转换设置
        function saveImageSettings() {
            imageSettings.autoDownload = $('#autoDownload').is(':checked');
            imageSettings.autoCopyBase64 = $('#autoCopyBase64').is(':checked');
            imageSettings.autoEncodeDecode = $('#autoEncodeDecode').is(':checked');
            imageSettings.outputFormat = $('#outputFormat').val();
            
            localStorage.setItem('imageSettings', JSON.stringify(imageSettings));
        }

        // 初始化文件上传功能
        function initializeImageUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('imageInput');

            // 拖拽事件处理
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            // 点击选择文件
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            // 文件选择变化
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
        }

        // 处理文件选择
        function handleFileSelect(file) {
            if (!isValidImageFile(file)) {
                showAlert('无效的图片格式。', 'danger');
                return;
            }

            if (file.size > 50 * 1024 * 1024) { // 50MB
                showAlert('文件大小超过50MB限制。', 'danger');
                return;
            }

            currentFile = file;
            displayImage(file);
        }

        // 验证图片文件类型
        function isValidImageFile(file) {
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml'];
            return validTypes.includes(file.type);
        }

        // 显示图片
        function displayImage(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = $('#displayImg');
                img.attr('src', e.target.result);
                currentImageSrc = e.target.result;
                
                // 显示图片信息
                const sizeKB = (file.size / 1024).toFixed(1);
                $('#imageInfo').text(`${file.name} (${sizeKB}KB)`);
                
                // 切换显示区域
                $('#uploadArea').hide();
                $('#imageDisplay').show();
                
                // 自动编码（如果启用了）
                if (imageSettings.autoEncodeDecode) {
                    setTimeout(() => {
                        imageToBase64();
                    }, 100);
                }
            };
            reader.readAsDataURL(file);
        }

        // 图片转Base64
        function imageToBase64() {
            if (!currentFile && !currentImageSrc) {
                showAlert('请先选择或上传图片。', 'warning');
                return;
            }

            showAlert('正在处理图片...', 'info');
            
            try {
                let imageSrc = currentImageSrc;
                if (currentFile) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        processImageToBase64(e.target.result);
                    };
                    reader.readAsDataURL(currentFile);
                } else {
                    processImageToBase64(imageSrc);
                }
            } catch (e) {
                showAlert('图片编码失败：' + e.message, 'danger');
            }
        }

        // 处理图片到Base64的转换
        function processImageToBase64(imageSrc) {
            const img = new Image();
            img.onload = function() {
                try {
                    let canvas = document.createElement('canvas');
                    let ctx = canvas.getContext('2d');
                    
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // 绘制图片
                    ctx.drawImage(img, 0, 0);
                    
                    // 获取Base64
                    const mimeType = currentFile ? currentFile.type : 'image/png';
                    const base64String = canvas.toDataURL(mimeType, 0.9);
                    
                    currentBase64 = base64String;
                    
                    // 根据设置的输出格式显示结果
                    const formattedOutput = formatOutput(base64String, imageSettings.outputFormat);
                    $('#base64Text').val(formattedOutput);
                    
                    // 自动复制（如果启用）
                    if (imageSettings.autoCopyBase64) {
                        copyToClipboard(formattedOutput);
                        showAlert('图片已转换并复制到剪贴板！', 'success');
                    } else {
                        showAlert('图片已成功转换！', 'success');
                    }
                    
                } catch (e) {
                    showAlert('图片编码失败：' + e.message, 'danger');
                }
            };
            img.src = imageSrc;
        }

        // 格式化输出函数
        function formatOutput(base64String, format) {
            const base64Data = base64String.split(',')[1]; // 只获取base64数据部分
            const mimeType = base64String.split(';')[0].split(':')[1] || 'image/png';
            
            switch (format) {
                case 'base64':
                    return base64Data;
                case 'datauri':
                    return base64String;
                case 'css':
                    return `background-image: url('${base64String}');`;
                case 'favicon':
                    return `<link rel="icon" href="${base64String}" type="${mimeType}" />`;
                case 'hyperlink':
                    return `<a href="${base64String}" target="_blank">View Image</a>`;
                case 'img':
                    return `<img src="${base64String}" alt="Base64 Image" />`;
                case 'iframe':
                    return `<iframe src="${base64String}" width="100%" height="400"></iframe>`;
                case 'jsimage':
                    return `var img = new Image(); img.src = '${base64String}';`;
                case 'jspopup':
                    return `window.open('${base64String}', '_blank');`;
                case 'json':
                    return JSON.stringify({
                        image: {
                            mime: mimeType,
                            data: base64Data
                        }
                    }, null, 2);
                case 'xml':
                    return `<image mime="${mimeType}">${base64Data}</image>`;
                default:
                    return base64String;
            }
        }

        // Base64转图片
        function base64ToImage() {
            const base64Input = $('#base64Text').val().trim();
            
            if (!base64Input) {
                showAlert('请粘贴Base64字符串。', 'warning');
                return;
            }

            showAlert('正在处理Base64...', 'info');

            try {
                // 尝试从输入中提取数据URI
                let dataUri = extractDataURI(base64Input);
                
                if (!dataUri) {
                    showAlert('无效的Base64图片格式。', 'danger');
                    return;
                }

                // 显示图片结果
                const img = $('#displayImg');
                img.attr('src', dataUri);
                currentImageSrc = dataUri;
                currentBase64 = dataUri;
                
                // 显示图片信息
                const size = Math.round(dataUri.length * 0.75 / 1024); // 估算KB大小
                $('#imageInfo').text(`Base64解码图片 (约${size}KB)`);
                
                // 切换显示区域
                $('#uploadArea').hide();
                $('#imageDisplay').show();
                
                showAlert('Base64已成功转换为图片！', 'success');
                
                // 自动下载（如果启用）
                if (imageSettings.autoDownload) {
                    setTimeout(() => downloadImage(), 1000);
                }
            } catch (e) {
                showAlert('Base64解码失败：' + e.message, 'danger');
            }
        }

        // 交换内容
        function swapContent() {
            // 如果有图片但没有Base64，先编码
            if (currentImageSrc && !currentBase64) {
                imageToBase64();
                setTimeout(() => {
                    showAlert('内容已交换！', 'info');
                }, 500);
                return;
            }
            
            // 如果有Base64但没有图片，先解码
            const base64Text = $('#base64Text').val().trim();
            if (base64Text && !currentImageSrc) {
                // 尝试从输入中提取数据URI
                const dataUri = extractDataURI(base64Text);
                if (dataUri) {
                    $('#base64Text').val(dataUri);
                    base64ToImage();
                    setTimeout(() => {
                        showAlert('内容已交换！', 'info');
                    }, 500);
                    return;
                }
            }
            
            showAlert('内容已交换！', 'info');
        }

        // 从各种格式中提取数据URI
        function extractDataURI(text) {
            // 如果已经是数据URI格式
            if (text.startsWith('data:image/')) {
                return text;
            }
            
            // 从各种格式中提取
            const patterns = [
                /url\(['"](data:image\/[^'"]+)['"]/,  // CSS
                /href=['"]([^'"]+\.(?:png|jpg|jpeg|gif|webp|svg))['"]/, // Favicon/Hyperlink
                /src=['"]([^'"]+)['"]/,  // IMG/Iframe
                /img\.src\s*=\s*['"](data:image\/[^'"]+)['"]/,  // JS Image
                /window\.open\(['"](data:image\/[^'"]+)['"]/, // JS Popup
            ];
            
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match && match[1] && match[1].startsWith('data:image/')) {
                    return match[1];
                }
            }
            
            // 尝试JSON格式
            try {
                const json = JSON.parse(text);
                if (json.image && json.image.data && json.image.mime) {
                    return `data:${json.image.mime};base64,${json.image.data}`;
                }
            } catch (e) {}
            
            // 尝试XML格式
            const xmlMatch = text.match(/<image[^>]*mime=['"]([^'"]+)['"][^>]*>([^<]+)<\/image>/);
            if (xmlMatch && xmlMatch[1] && xmlMatch[2]) {
                return `data:${xmlMatch[1]};base64,${xmlMatch[2]}`;
            }
            
            // 如果是纯粹的Base64，尝试检测图片类型
            if (/^[A-Za-z0-9+/]*={0,2}$/.test(text) && text.length > 100) {
                // 尝试检测图片类型
                const imageType = detectImageTypeFromBase64(text);
                return `data:${imageType};base64,${text}`;
            }
            
            return null;
        }



        // 选择图片（按钮点击）
        function selectImage() {
            $('#imageInput').click();
        }

        // 清空图片
        function clearImage() {
            currentFile = null;
            currentImageSrc = null;
            $('#imageDisplay').hide();
            $('#uploadArea').show();
            $('#imageInput').val('');
            $('#imageInfo').text('');
        }

        // 清空Base64输入
        function clearBase64() {
            currentBase64 = null;
            $('#base64Text').val('');
            $('#formatOutputCard').hide();
        }

        // 复制Base64
        function copyBase64() {
            const base64Text = $('#base64Text').val();
            if (!base64Text) {
                showAlert('没有Base64内容可复制。', 'warning');
                return;
            }
            copyToClipboard(base64Text);
            showAlert('Base64已复制到剪贴板！', 'success');
        }

        // 复制图片（复制Base64）
        function copyImage() {
            if (currentImageSrc) {
                copyToClipboard(currentImageSrc);
                showAlert('图片Base64已复制到剪贴板！', 'success');
            } else {
                showAlert('没有图片可复制。', 'warning');
            }
        }

        // 下载图片
        function downloadImage() {
            const imgSrc = currentImageSrc || $('#base64Text').val().trim();
            if (!imgSrc) {
                showAlert('没有图片可下载。', 'warning');
                return;
            }
            
            // 创建下载链接
            const link = document.createElement('a');
            link.href = imgSrc;
            link.download = 'converted-image.' + getImageExtensionFromBase64(imgSrc);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('图片已下载！', 'success');
        }

        // 清空所有内容
        function clearAll() {
            clearImage();
            clearBase64();
            showAlert('所有内容已清空。', 'info');
        }

        // 从Base64获取图片扩展名
        function getImageExtensionFromBase64(base64String) {
            if (base64String.includes('image/jpeg') || base64String.includes('image/jpg')) return 'jpg';
            if (base64String.includes('image/png')) return 'png';
            if (base64String.includes('image/gif')) return 'gif';
            if (base64String.includes('image/webp')) return 'webp';
            if (base64String.includes('image/svg')) return 'svg';
            return 'png'; // 默认
        }

        // 检测Base64字符串的图片类型
        function detectImageTypeFromBase64(base64String) {
            try {
                // 解码Base64的前几个字节来检测图片类型
                const binaryString = atob(base64String);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                // 检测文件头
                if (bytes.length >= 4) {
                    // PNG: 89 50 4E 47
                    if (bytes[0] === 0x89 && bytes[1] === 0x50 && bytes[2] === 0x4E && bytes[3] === 0x47) {
                        return 'image/png';
                    }
                    // JPEG: FF D8 FF
                    if (bytes[0] === 0xFF && bytes[1] === 0xD8 && bytes[2] === 0xFF) {
                        return 'image/jpeg';
                    }
                    // GIF: 47 49 46 38 (GIF8)
                    if (bytes[0] === 0x47 && bytes[1] === 0x49 && bytes[2] === 0x46 && bytes[3] === 0x38) {
                        return 'image/gif';
                    }
                    // WebP: 52 49 46 46 (RIFF)
                    if (bytes[0] === 0x52 && bytes[1] === 0x49 && bytes[2] === 0x46 && bytes[3] === 0x46) {
                        return 'image/webp';
                    }
                }
                
                // 如果是SVG，检查是否包含SVG标记
                const decodedString = binaryString.toString();
                if (decodedString.includes('<svg') || decodedString.includes('<?xml')) {
                    return 'image/svg+xml';
                }
                
            } catch (e) {
                // 如果检测失败，返回默认类型
            }
            
            // 默认返回PNG
            return 'image/png';
        }

        // 复制到剪贴板通用函数
        function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                return navigator.clipboard.writeText(text);
            } else {
                // 降级方案
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            }
        }

        // 显示提示消息
        function showAlert(message, type = 'info') {
            const alertElement = $('#alertMessage');
            
            // 清除之前的定时器（如果存在）
            const existingTimer = alertElement.data('hideTimer');
            if (existingTimer) {
                clearTimeout(existingTimer);
            }
            
            alertElement
                .removeClass()
                .addClass(`alert alert-${type}`)
                .text(message)
                .show();

            // 10秒后自动隐藏，并保存定时器ID
            const hideTimer = setTimeout(() => {
                alertElement.hide();
                alertElement.removeData('hideTimer');
            }, 10000);
            
            alertElement.data('hideTimer', hideTimer);
        }

        // 更新质量显示
        function updateOutputFormat() {
            if (currentBase64) {
                const formattedOutput = formatOutput(currentBase64, imageSettings.outputFormat);
                $('#base64Text').val(formattedOutput);
            }
        }

        // 初始化工具提示
        function initializeTooltips() {
            if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }
        }

        // 设置事件监听器
        function setupImageEventListeners() {
            // 设置项变化监听
            $('#autoDownload, #autoCopyBase64, #autoEncodeDecode').on('change', function() {
                saveImageSettings();
            });
            
            $('#outputFormat').on('change', function() {
                imageSettings.outputFormat = $(this).val();
                saveImageSettings();
                updateOutputFormat();
            });
        }
    </script>

    <style>
        html,
        body {
            background: rgb(245 246 255);
            min-width: 100%;
            min-height: 100%;
            margin: 0;
            padding: 0;
        }

        /* 上传区域样式 */
        .image-display-area {
            background: #fff !important;
            border-radius: 10px !important;
            box-shadow: 0 2px 8px 0 rgba(96, 114, 252, .05) !important;
            padding: 12px !important;
            min-height: 300px !important;
            height: 50vh;
            width: 100%;
            border: 1px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-display-area:hover {
            border-color: #86b7fe;
            box-shadow: 0 0 0 1px rgba(13, 110, 253, 0.1);
        }

        .image-display-area.dragover {
            border-color: #0d6efd;
            background-color: #cfe2ff !important;
            transform: scale(1.02);
        }

        .upload-content {
            pointer-events: none;
            text-align: center;
        }

        /* 图片预览样式 */
        .preview-image {
            max-width: 100%;
            max-height: calc(100% - 40px);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* 强化textarea样式，确保能够调整大小和自动换行 */
        .code-input {
            background: #fff !important;
            border-radius: 10px !important;
            box-shadow: 0 2px 8px 0 rgba(96, 114, 252, .05) !important;
            padding: 12px !important;
            min-height: 300px !important;
            height: 50vh;
            width: 100%;
            border: 1px solid #fff;
            resize: vertical !important;
            /* 强制自动换行设置 */
            white-space: pre-wrap !important;
            word-wrap: break-word !important;
            word-break: break-all !important;
            overflow-wrap: break-word !important;
            /* 确保有滚动条 */
            overflow-y: auto !important;
            font-family: monospace;
            font-size: 0.875rem;
        }

        /* 鼠标悬浮时的提示效果 */
        .code-input:hover {
            border-color: #86b7fe;
            box-shadow: 0 0 0 1px rgba(13, 110, 253, 0.1);
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        /* 移动端布局优化 - 上下排列和按钮位置调整 */
        @media (max-width: 768px) {
            /* 确保row容器支持flexbox order */
            .textarea-container {
                display: flex !important;
                flex-direction: column !important;
            }

            /* 移动端输入框上下排列 */
            .textarea-container .input-section,
            .textarea-container .output-section {
                flex: 0 0 100% !important;
                max-width: 100% !important;
                margin-bottom: 20px;
            }

            /* 移动端输入框高度调整 */
            .code-input,
            .image-display-area {
                min-height: 200px !important;
                height: 40vh !important;
            }

            /* 移动端显示中间按钮，隐藏桌面按钮 */
            .mobile-buttons {
                display: block !important;
                order: 2;
                /* 确保在输入框和输出框之间 */
            }

            .desktop-buttons {
                display: none !important;
            }

            /* 调整输入框顺序 */
            .input-section {
                order: 1;
            }

            .output-section {
                order: 3;
            }

            /* 移动端按钮样式优化 */
            .mobile-buttons .btn {
                font-size: 14px;
                padding: 10px 15px;
                margin: 0 5px;
            }

            /* 移动端按钮容器样式 */
            .mobile-buttons {
                padding: 15px 0;
                background: rgba(245, 246, 255, 0.5);
                border-radius: 10px;
                margin: 15px 0;
            }
        }

        /* 桌面端隐藏移动端按钮 */
        @media (min-width: 769px) {
            .mobile-buttons {
                display: none !important;
            }

            .desktop-buttons {
                display: block !important;
            }

            .desktop-buttons .btn {
                height: 38px; /* 统一按钮高度 */
            }
        }

        div {
            box-sizing: border-box;
        }

        /* 设置区域样式优化 */
        .d-flex.flex-wrap.gap-3 {
            gap: 1rem !important;
        }

        /* 表单控件样式优化 */
        .form-control,
        .form-select,
        .form-range {
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        /* 开关样式优化 */
        .form-check-input[type="checkbox"] {
            cursor: pointer;
        }

        /* 小标签样式 */
        .form-label.small {
            font-weight: 500;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }

        /* 格式化输出卡片样式 */
        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 10px;
        }

        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            border-radius: 10px 10px 0 0 !important;
        }

        /* 按钮组样式 */
        .clear-btn,
        .copy-btn {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #dee2e6;
            border-radius: 4px;
            color: #6c757d;
        }

        .clear-btn:hover,
        .copy-btn:hover {
            background: rgba(255, 255, 255, 1);
            color: #495057;
        }

        /* 介绍栏样式 */
        .intro-section {
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 15px;
        }

        /* 移动端介绍栏调整 */
        @media (max-width: 768px) {
            .intro-section .d-flex {
                flex-direction: column !important;
                align-items: flex-start !important;
            }
            
            .intro-section h1 {
                margin-bottom: 5px !important;
                font-size: 1.2rem !important;
            }
            
            .intro-section h2 {
                font-size: 0.9rem !important;
            }
        }
    </style>
</body>

</html>
